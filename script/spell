#!/bin/bash

# script/spell: Run spell checking with codespell
#
# Runs codespell with write-changes enabled to automatically fix common typos.
# Only checks Python, Markdown, and RST files in custom_components and documentation.
#
# Usage:
#   ./script/spell
#
# Examples:
#   ./script/spell

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR/.."

# shellcheck source=script/.lib/output.sh
source "$SCRIPT_DIR/.lib/output.sh"

if [[ -z ${VIRTUAL_ENV:-} ]]; then
    log_header "Activating virtual environment"
    # shellcheck source=/dev/null
    if [[ -f "$PWD/.local/ha-venv/bin/activate" ]]; then
        source "$PWD/.local/ha-venv/bin/activate"
    elif [[ -f "$HOME/.local/ha-venv/bin/activate" ]]; then
        source "$HOME/.local/ha-venv/bin/activate"
    else
        log_error "Virtual environment not found in $PWD/.local/ha-venv or $HOME/.local/ha-venv"
        exit 1
    fi
fi

log_header "Running codespell with auto-fix"
codespell \
    --write-changes \
    --ignore-words-list=aiport,astroid,checkin,currenty,hass,iif,incomfort,lookin,nam,NotIn \
    --skip="./.*,*.csv,*.json,*.ambr,uv.lock" \
    --quiet-level=2 \
    custom_components/ \
    README.md \
    CONTRIBUTING.md \
    DEPENDENCIES.md \
    script/ \
    tests/ 2>&1 || true

# Clean up any accidental package installation from uv run
"$SCRIPT_DIR/clean" --minimal

log_success "Spell checking completed"
